-- ============================================================================
-- Hobbly Database Initialization Script
-- ============================================================================
-- –û–ø–∏—Å–∞–Ω–∏–µ: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Hobbly
-- –í–µ—Ä—Å–∏—è: 1.0.0
-- ============================================================================

-- –í–∫–ª—é—á–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================================================
-- –°–û–ó–î–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶
-- ============================================================================

-- -----------------------------------------------------------------------------
-- –¢–∞–±–ª–∏—Ü–∞: categories (–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π)
-- -----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS categories (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    icon VARCHAR(50),
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE categories IS '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π';
COMMENT ON COLUMN categories.id IS '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
COMMENT ON COLUMN categories.name IS '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
COMMENT ON COLUMN categories.icon IS '–ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (emoji –∏–ª–∏ URL)';
COMMENT ON COLUMN categories.description IS '–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';

-- -----------------------------------------------------------------------------
-- –¢–∞–±–ª–∏—Ü–∞: tags (–¢–µ–≥–∏)
-- -----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS tags (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    color VARCHAR(7) DEFAULT '#808080',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE tags IS '–¢–µ–≥–∏ –¥–ª—è –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π';
COMMENT ON COLUMN tags.id IS '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–≥–∞';
COMMENT ON COLUMN tags.name IS '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞';
COMMENT ON COLUMN tags.color IS '–¶–≤–µ—Ç —Ç–µ–≥–∞ –≤ HEX —Ñ–æ—Ä–º–∞—Ç–µ';

-- -----------------------------------------------------------------------------
-- –¢–∞–±–ª–∏—Ü–∞: activities (–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏/–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
-- -----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS activities (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    short_description VARCHAR(100),
    type VARCHAR(50) NOT NULL CHECK (type IN ('activity', 'event', 'hobby_opportunity', 'club', 'competition')),
    category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
    location VARCHAR(255) NOT NULL,
    address TEXT,
    coordinates JSONB,
    price DECIMAL(10, 2) DEFAULT 0,
    currency VARCHAR(3) DEFAULT 'EUR',
    image_url TEXT,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    start_date TIMESTAMP WITH TIME ZONE,
    end_date TIMESTAMP WITH TIME ZONE,
    max_participants INTEGER,
    min_age INTEGER CHECK (min_age >= 0),
    max_age INTEGER CHECK (max_age >= 0),
    contact_email VARCHAR(255),
    contact_phone VARCHAR(50),
    external_link TEXT,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT age_check CHECK (min_age IS NULL OR max_age IS NULL OR min_age <= max_age),
    CONSTRAINT date_check CHECK (start_date IS NULL OR end_date IS NULL OR start_date <= end_date)
);

CREATE INDEX idx_activities_user_id ON activities(user_id);
CREATE INDEX idx_activities_category_id ON activities(category_id);
CREATE INDEX idx_activities_type ON activities(type);
CREATE INDEX idx_activities_is_deleted ON activities(is_deleted);
CREATE INDEX idx_activities_location ON activities(location);
CREATE INDEX idx_activities_price ON activities(price);
CREATE INDEX idx_activities_created_at ON activities(created_at DESC);

COMMENT ON TABLE activities IS '–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π';
COMMENT ON COLUMN activities.id IS '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
COMMENT ON COLUMN activities.title IS '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
COMMENT ON COLUMN activities.description IS '–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
COMMENT ON COLUMN activities.short_description IS '–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤)';
COMMENT ON COLUMN activities.type IS '–¢–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
COMMENT ON COLUMN activities.category_id IS '–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
COMMENT ON COLUMN activities.location IS '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è';
COMMENT ON COLUMN activities.address IS '–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å';
COMMENT ON COLUMN activities.coordinates IS 'GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON {lat, lng}';
COMMENT ON COLUMN activities.price IS '–¶–µ–Ω–∞ —É—á–∞—Å—Ç–∏—è';
COMMENT ON COLUMN activities.currency IS '–í–∞–ª—é—Ç–∞ —Ü–µ–Ω—ã (ISO 4217)';
COMMENT ON COLUMN activities.image_url IS 'URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
COMMENT ON COLUMN activities.user_id IS 'ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)';
COMMENT ON COLUMN activities.is_deleted IS '–§–ª–∞–≥ –º—è–≥–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è (–¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã)';

-- -----------------------------------------------------------------------------
-- –¢–∞–±–ª–∏—Ü–∞: activity_tags (–°–≤—è–∑—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∏ —Ç–µ–≥–æ–≤)
-- -----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS activity_tags (
    activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
    tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (activity_id, tag_id)
);

CREATE INDEX idx_activity_tags_activity_id ON activity_tags(activity_id);
CREATE INDEX idx_activity_tags_tag_id ON activity_tags(tag_id);

COMMENT ON TABLE activity_tags IS '–°–≤—è–∑—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º–∏ –∏ —Ç–µ–≥–∞–º–∏';
COMMENT ON COLUMN activity_tags.activity_id IS 'ID –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
COMMENT ON COLUMN activity_tags.tag_id IS 'ID —Ç–µ–≥–∞';

-- -----------------------------------------------------------------------------
-- –¢–∞–±–ª–∏—Ü–∞: user_profiles (–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
-- -----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS user_profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    full_name VARCHAR(255),
    organization_name VARCHAR(255),
    phone VARCHAR(50),
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'organizer', 'admin')),
    avatar_url TEXT,
    bio TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_profiles_email ON user_profiles(email);
CREATE INDEX idx_user_profiles_role ON user_profiles(role);
CREATE INDEX idx_user_profiles_organization ON user_profiles(organization_name);

COMMENT ON TABLE user_profiles IS '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
COMMENT ON COLUMN user_profiles.id IS 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ auth.users';
COMMENT ON COLUMN user_profiles.email IS 'Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
COMMENT ON COLUMN user_profiles.full_name IS '–ü–æ–ª–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
COMMENT ON COLUMN user_profiles.organization_name IS '–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤)';
COMMENT ON COLUMN user_profiles.role IS '–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ';

-- ============================================================================
-- –§–£–ù–ö–¶–ò–ò –ò –¢–†–ò–ì–ì–ï–†–´
-- ============================================================================

-- -----------------------------------------------------------------------------
-- –§—É–Ω–∫—Ü–∏—è: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ updated_at
-- -----------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä –∫ —Ç–∞–±–ª–∏—Ü–∞–º
CREATE TRIGGER update_categories_updated_at BEFORE UPDATE ON categories
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_activities_updated_at BEFORE UPDATE ON activities
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_profiles_updated_at BEFORE UPDATE ON user_profiles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- -----------------------------------------------------------------------------
-- –§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
-- -----------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO user_profiles (
        id, 
        email, 
        full_name,
        organization_name,
        phone,
        role
    ) VALUES (
        NEW.id,
        NEW.email,
        NEW.raw_user_meta_data->>'fullName',
        NEW.raw_user_meta_data->>'organizationName',
        NEW.phone,
        COALESCE(NEW.raw_user_meta_data->>'role', 'user')
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION handle_new_user();

-- -----------------------------------------------------------------------------
-- –§—É–Ω–∫—Ü–∏—è: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
-- -----------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION generate_short_description()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.short_description IS NULL OR NEW.short_description = '' THEN
        NEW.short_description = LEFT(NEW.description, 97) || '...';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER generate_activity_short_description
    BEFORE INSERT OR UPDATE ON activities
    FOR EACH ROW EXECUTE FUNCTION generate_short_description();

-- ============================================================================
-- –í–°–¢–ê–í–ö–ê –ù–ê–ß–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–•
-- ============================================================================

-- –í—Å—Ç–∞–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
INSERT INTO categories (name, icon, description) VALUES
    ('–°–ø–æ—Ä—Ç –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '‚öΩ', '–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è'),
    ('–ú—É–∑—ã–∫–∞ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å—Å–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ', 'üéµ', '–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –∫—Ä—É–∂–∫–∏, –∫–æ–Ω—Ü–µ—Ä—Ç—ã, —Ç–µ–∞—Ç—Ä'),
    ('–†–µ–º–µ—Å–ª–∞ –∏ –∏—Å–∫—É—Å—Å—Ç–≤–æ', 'üé®', '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç—É–¥–∏–∏, —Ä—É–∫–æ–¥–µ–ª–∏–µ, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ'),
    ('–ù–∞—É–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', 'üî¨', '–ù–∞—É—á–Ω—ã–µ –∫—Ä—É–∂–∫–∏, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞'),
    ('–ò–≥—Ä—ã –∏ –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç', 'üéÆ', '–ò–≥—Ä–æ–≤—ã–µ –∫–ª—É–±—ã, —Ç—É—Ä–Ω–∏—Ä—ã, –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã'),
    ('–ï–¥–∞ –∏ –∫—É–ª–∏–Ω–∞—Ä–∏—è', 'üç≥', '–ö—É–ª–∏–Ω–∞—Ä–Ω—ã–µ –∫—É—Ä—Å—ã, –¥–µ–≥—É—Å—Ç–∞—Ü–∏–∏, –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã'),
    ('–ü—Ä–∏—Ä–æ–¥–∞ –∏ —Ç—É—Ä–∏–∑–º', 'üèïÔ∏è', '–ü–æ—Ö–æ–¥—ã, —ç–∫—Å–∫—É—Ä—Å–∏–∏, —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã'),
    ('–ö—É–ª—å—Ç—É—Ä–∞ –∏ –∏—Å—Ç–æ—Ä–∏—è', 'üèõÔ∏è', '–ú—É–∑–µ–∏, –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∫–ª—É–±—ã, –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è'),
    ('–°–æ–æ–±—â–µ—Å—Ç–≤–æ –∏ –¥–æ–±—Ä–æ–≤–æ–ª—å—á–µ—Å—Ç–≤–æ', 'ü§ù', '–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—Ç–≤–æ, —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –ø–æ–º–æ—â—å'),
    ('–î–µ—Ç–∏ –∏ —Å–µ–º—å–∏', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', '–°–µ–º–µ–π–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –¥–µ—Ç—Å–∫–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏')
ON CONFLICT (name) DO NOTHING;

-- –í—Å—Ç–∞–≤–∫–∞ —Ç–µ–≥–æ–≤
INSERT INTO tags (name, color) VALUES
    ('–ë–µ—Å–ø–ª–∞—Ç–Ω–æ', '#65FF81'),
    ('–û—Ç–∫—Ä—ã—Ç–æ –¥–ª—è –≤—Å–µ—Ö', '#F5FF65'),
    ('–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö', '#73B3FF'),
    ('–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ', '#FF9473'),
    ('–û–Ω–ª–∞–π–Ω', '#B473FF'),
    ('–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–µ–º–µ–π', '#65FF81'),
    ('–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–æ–∂–∏–ª—ã—Ö', '#F5FF65'),
    ('–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Å–æ–±—ã—Ö –≥—Ä—É–ø–ø', '#73B3FF'),
    ('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è', '#FF9473'),
    ('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', '#B473FF')
ON CONFLICT (name) DO NOTHING;

-- ============================================================================
-- ROW LEVEL SECURITY (RLS)
-- ============================================================================

-- –í–∫–ª—é—á–∞–µ–º RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE activity_tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- -----------------------------------------------------------------------------
-- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è categories
-- -----------------------------------------------------------------------------
-- –í—Å–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
CREATE POLICY "Categories are viewable by everyone" ON categories
    FOR SELECT USING (true);

-- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
CREATE POLICY "Only admins can manage categories" ON categories
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE user_profiles.id = auth.uid()
            AND user_profiles.role = 'admin'
        )
    );

-- -----------------------------------------------------------------------------
-- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è tags
-- -----------------------------------------------------------------------------
-- –í—Å–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å —Ç–µ–≥–∏
CREATE POLICY "Tags are viewable by everyone" ON tags
    FOR SELECT USING (true);

-- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ç–µ–≥–∏
CREATE POLICY "Only admins can manage tags" ON tags
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE user_profiles.id = auth.uid()
            AND user_profiles.role = 'admin'
        )
    );

-- -----------------------------------------------------------------------------
-- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è activities
-- -----------------------------------------------------------------------------
-- –í—Å–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –Ω–µ—É–¥–∞–ª–µ–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
CREATE POLICY "Activities are viewable by everyone" ON activities
    FOR SELECT USING (is_deleted = FALSE);

-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
CREATE POLICY "Organizers can create activities" ON activities
    FOR INSERT WITH CHECK (
        auth.uid() = user_id AND
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE user_profiles.id = auth.uid()
            AND user_profiles.role IN ('organizer', 'admin')
        )
    );

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
CREATE POLICY "Users can update own activities" ON activities
    FOR UPDATE USING (
        auth.uid() = user_id OR
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE user_profiles.id = auth.uid()
            AND user_profiles.role = 'admin'
        )
    );

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
CREATE POLICY "Users can delete own activities" ON activities
    FOR DELETE USING (
        auth.uid() = user_id OR
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE user_profiles.id = auth.uid()
            AND user_profiles.role = 'admin'
        )
    );

-- -----------------------------------------------------------------------------
-- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è activity_tags
-- -----------------------------------------------------------------------------
-- –í—Å–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å —Å–≤—è–∑–∏ —Ç–µ–≥–æ–≤
CREATE POLICY "Activity tags are viewable by everyone" ON activity_tags
    FOR SELECT USING (true);

-- –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–≥–∞–º–∏
CREATE POLICY "Activity owners can manage tags" ON activity_tags
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM activities
            WHERE activities.id = activity_tags.activity_id
            AND (
                activities.user_id = auth.uid() OR
                EXISTS (
                    SELECT 1 FROM user_profiles
                    WHERE user_profiles.id = auth.uid()
                    AND user_profiles.role = 'admin'
                )
            )
        )
    );

-- -----------------------------------------------------------------------------
-- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è user_profiles
-- -----------------------------------------------------------------------------
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏
CREATE POLICY "Profiles are viewable by everyone" ON user_profiles
    FOR SELECT USING (true);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
CREATE POLICY "Users can update own profile" ON user_profiles
    FOR UPDATE USING (
        auth.uid() = id OR
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE user_profiles.id = auth.uid()
            AND user_profiles.role = 'admin'
        )
    );

-- ============================================================================
-- –°–û–ó–î–ê–ù–ò–ï –•–†–ê–ù–ò–õ–ò–©–ê (Storage Bucket)
-- ============================================================================

-- –°–æ–∑–¥–∞–µ–º bucket –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
INSERT INTO storage.buckets (id, name, public, avif_autodetection, file_size_limit, allowed_mime_types)
VALUES (
    'activities',
    'activities',
    true,
    false,
    5242880, -- 5MB
    ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp']
) ON CONFLICT (id) DO NOTHING;

-- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
CREATE POLICY "Anyone can view activity images" ON storage.objects
    FOR SELECT USING (bucket_id = 'activities');

CREATE POLICY "Authenticated users can upload activity images" ON storage.objects
    FOR INSERT WITH CHECK (
        bucket_id = 'activities' AND
        auth.uid() IS NOT NULL
    );

CREATE POLICY "Users can update own activity images" ON storage.objects
    FOR UPDATE USING (
        bucket_id = 'activities' AND
        auth.uid()::text = (storage.foldername(name))[1]
    );

CREATE POLICY "Users can delete own activity images" ON storage.objects
    FOR DELETE USING (
        bucket_id = 'activities' AND
        auth.uid()::text = (storage.foldername(name))[1]
    );

-- ============================================================================
-- –°–û–ó–î–ê–ù–ò–ï –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–ô (Views)
-- ============================================================================

-- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
CREATE OR REPLACE VIEW activities_full AS
SELECT 
    a.*,
    c.name as category_name,
    c.icon as category_icon,
    u.full_name as organizer_name,
    u.organization_name as organizer_organization,
    u.email as organizer_email,
    COALESCE(
        json_agg(
            DISTINCT jsonb_build_object(
                'id', t.id,
                'name', t.name,
                'color', t.color
            )
        ) FILTER (WHERE t.id IS NOT NULL),
        '[]'::json
    ) as tags
FROM activities a
LEFT JOIN categories c ON a.category_id = c.id
LEFT JOIN user_profiles u ON a.user_id = u.id
LEFT JOIN activity_tags at ON a.id = at.activity_id
LEFT JOIN tags t ON at.tag_id = t.id
WHERE a.is_deleted = FALSE
GROUP BY a.id, c.name, c.icon, u.full_name, u.organization_name, u.email;

-- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—é
GRANT SELECT ON activities_full TO anon, authenticated;

-- ============================================================================
-- –§–ò–ù–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
-- ============================================================================

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX activities_search_idx ON activities 
USING gin(to_tsvector('russian', title || ' ' || description));

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
CREATE OR REPLACE FUNCTION search_activities(search_query text)
RETURNS SETOF activities AS $$
BEGIN
    RETURN QUERY
    SELECT * FROM activities
    WHERE 
        is_deleted = FALSE AND
        (
            to_tsvector('russian', title || ' ' || description) @@ plainto_tsquery('russian', search_query)
            OR title ILIKE '%' || search_query || '%'
            OR description ILIKE '%' || search_query || '%'
            OR location ILIKE '%' || search_query || '%'
        )
    ORDER BY created_at DESC;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- –ö–û–ù–ï–¶ –°–ö–†–ò–ü–¢–ê
-- ============================================================================

-- –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
DO $$
BEGIN
    RAISE NOTICE '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö Hobbly —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!';
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã: categories, tags, activities, activity_tags, user_profiles';
    RAISE NOTICE '–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (RLS)';
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π';
    RAISE NOTICE '–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
END $$;
